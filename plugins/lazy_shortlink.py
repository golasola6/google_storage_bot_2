
import logging

from pyrogram import Client, filters, enums
from database.database import db
from config import *
import re
from utils import save_group_settings , get_settings
logger = logging.getLogger(__name__)

BATCH_FILES = {}


@Client.on_message(filters.command("shortlink"))
async def shortlink(bot, message):
    userid = message.from_user.id if message.from_user else None
    if not userid:
        return await message.reply(f"Êá´á´œ'Ê€á´‡ á´€É´á´É´Êá´á´á´œêœ± á´€á´…á´ÉªÉ´, á´›á´œÊ€É´ á´êœ°êœ° á´€É´á´É´Êá´á´á´œêœ± á´€á´…á´ÉªÉ´ á´€É´á´… á´›Ê€Ê á´›ÊœÉªêœ± á´€É¢á´€ÉªÉ´ á´„á´á´á´á´€É´á´….")
    chat_type = message.chat.type
    if chat_type == enums.ChatType.PRIVATE:
        chatid = userid
        title = message.from_user.first_name
    else:
        return
    data = message.text
    userid = message.from_user.id
    try:
        command, shortlink_url, api = data.split(" ")
    except:
        return await message.reply_text("<b>á´„á´á´á´á´€É´á´… ÉªÉ´á´„á´á´á´˜ÊŸá´‡á´›á´‡ !\nÉ¢Éªá´ á´‡ á´á´‡ á´„á´á´á´á´€É´á´… á´€ÊŸá´É´É¢ á´¡Éªá´›Êœ êœ±Êœá´Ê€á´›É´á´‡Ê€ á´¡á´‡Ê™êœ±Éªá´›á´‡ á´€É´á´… á´€á´˜Éª.\n\nêœ°á´Ê€á´á´€á´› : <code>/shortlink lazydeveloperr.com c8dacdff6e91a8e4b4f093fdb4d8ae31bc273c1a</code>")
    reply = await message.reply_text("<b>á´˜ÊŸá´‡á´€êœ±á´‡ á´¡á´€Éªá´›...</b>")
    shortlink_url = re.sub(r"https?://?", "", shortlink_url)
    shortlink_url = re.sub(r"[:/]", "", shortlink_url)
    await save_group_settings(chatid, 'shortlink', shortlink_url)
    await save_group_settings(chatid, 'shortlink_api', api)
    await save_group_settings(chatid, 'url_mode', True)
    await reply.edit_text(f"<b>âœ… êœ±á´œá´„á´„á´‡êœ±êœ±êœ°á´œÊŸÊŸÊ á´€á´…á´…á´‡á´… êœ±Êœá´Ê€á´›ÊŸÉªÉ´á´‹ êœ°á´Ê€ <code>{title}</code>.\n\nêœ±Êœá´Ê€á´›ÊŸÉªÉ´á´‹ á´¡á´‡Ê™êœ±Éªá´›á´‡ : <code>{shortlink_url}</code>\nêœ±Êœá´Ê€á´›ÊŸÉªÉ´á´‹ á´€á´˜Éª : <code>{api}</code></b>")



@Client.on_message(filters.command("shortlink_info"))
async def ginfo(bot, message):
    userid = message.from_user.id 

    settings = await get_settings(userid) #fetching settings for group
    if 'shortlink' in settings.keys() and 'tutorial' in settings.keys():
        su = settings['shortlink']
        sa = settings['shortlink_api']
        st = settings['tutorial']
        return await message.reply_text(f"<b><u>á´„á´œÊ€Ê€á´‡É´á´›  êœ±á´›á´€á´›á´œêœ±<u> ğŸ“Š\n\ná´¡á´‡Ê™êœ±Éªá´›á´‡ : <code>{su}</code>\n\ná´€á´˜Éª : <code>{sa}</code>\n\ná´›á´œá´›á´Ê€Éªá´€ÊŸ : {st}</b>", disable_web_page_preview=True)
    elif 'shortlink' in settings.keys() and 'tutorial' not in settings.keys():
        su = settings['shortlink']
        sa = settings['shortlink_api']
        return await message.reply_text(f"<b><u>á´„á´œÊ€Ê€á´‡É´á´›  êœ±á´›á´€á´›á´œêœ±<u> ğŸ“Š\n\ná´¡á´‡Ê™êœ±Éªá´›á´‡ : <code>{su}</code>\n\ná´€á´˜Éª : <code>{sa}</code>\n\ná´œêœ±á´‡ /set_tutorial á´„á´á´á´á´€É´á´… á´›á´ êœ±á´‡á´› Êá´á´œÊ€ á´›á´œá´›á´Ê€Éªá´€ÊŸ.")
    elif 'shortlink' not in settings.keys() and 'tutorial' in settings.keys():
        st = settings['tutorial']
        return await message.reply_text(f"<b>á´›á´œá´›á´Ê€Éªá´€ÊŸ : <code>{st}</code>\n\ná´œêœ±á´‡  /shortlink  á´„á´á´á´á´€É´á´…  á´›á´  á´„á´É´É´á´‡á´„á´›  Êá´á´œÊ€  êœ±Êœá´Ê€á´›É´á´‡Ê€</b>")
    else:
        return await message.reply_text("êœ±Êœá´Ê€á´›É´á´‡Ê€ á´€É´á´… á´›á´œá´›á´Ê€Éªá´€ÊŸ á´€Ê€á´‡ É´á´á´› á´„á´É´É´á´‡á´„á´›á´‡á´….\n\ná´„Êœá´‡á´„á´‹ /set_tutorial  á´€É´á´…  /shortlink  á´„á´á´á´á´€É´á´….")
